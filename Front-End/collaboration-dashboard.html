<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>TaskFlow - Tableau de Bord</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
            font-family: Arial;
        }

        .dashboard-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 250px;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
        }
    </style>
</head>

<body>
    <div class="loader" id="loader">Chargement des données...</div>

    <div class="dashboard-container" style="display:none;" id="dashboard">
        <h1>Tableau de Bord - <span id="user-name"></span></h1>
        <button id="btn-logout">Se déconnecter</button>
        <hr>

        <div class="dashboard-cards">
            <div class="card">
                <h3>Tâches par statut</h3>
                <canvas id="tasks-status-chart"></canvas>
            </div>
            <div class="card">
                <h3>Historique des modifications</h3>
                <ul id="history-list"></ul>
            </div>
            <div class="card">
                <h3>Tâches urgentes / en retard</h3>
                <ul id="urgent-tasks"></ul>
            </div>
        </div>
    </div>

    <script>
        const baseURL = "http://127.0.0.1:8000/api";
        const token = localStorage.getItem('jwt');
        const me = parseJwt(token); 
        async function fetchData() {
            try {
                const [tRes] = await Promise.all([
                    fetch(`${baseURL}/tasks`, {
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Accept": "application/json"
                        }
                    }),
                ]);

                if (tRes.status === 401) throw new Error("Session expirée. Connectez-vous à nouveau.");

                const allTasks = await tRes.json();

          
                document.getElementById('loader').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

      
                document.getElementById('user-name').textContent = me.username;

                renderStatusChart(allTasks);
                renderHistory(allTasks);
                renderUrgentTasks(allTasks);

            } catch (err) {
                alert(err.message);
            }
        }

        function renderStatusChart(tasks) {
            const ctx = document.getElementById('tasks-status-chart').getContext('2d');
            const statusCounts = tasks.reduce((acc, t) => {
                const status = t.status || 'pending';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffcd56']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderHistory(tasks) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            const sorted = tasks
                .filter(t => t.updatedAt)
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            sorted.forEach(t => {
                const li = document.createElement('li');
                li.textContent = `${t.title} modifiée le ${new Date(t.updatedAt).toLocaleString()}`;
                historyList.appendChild(li);
            });
        }

        function renderUrgentTasks(tasks) {
            const urgentList = document.getElementById('urgent-tasks');
            urgentList.innerHTML = '';
            const today = new Date();
            const urgentTasks = tasks.filter(t => t.dueDate && new Date(t.dueDate) <= today)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            urgentTasks.forEach(t => {
                const li = document.createElement('li');
                li.textContent =
                    `${t.title} - Échéance: ${t.dueDate.split('T')[0]} (Priorité: ${priorityToText(t.priority)})`;
                urgentList.appendChild(li);
            });
        }

        function priorityToText(priority) {
            switch (priority) {
                case 1:
                    return "Low";
                case 2:
                    return "Medium";
                case 3:
                    return "High";
                default:
                    return "Unknown";
            }
        }


        function parseJwt(token) {
            if (!token) return null;
            const payload = token.split('.')[1];
            return JSON.parse(atob(payload));
        }

        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem('jwt');
            window.location.href = 'index.html';
        });

        fetchData();
    </script>
</body>

</html>